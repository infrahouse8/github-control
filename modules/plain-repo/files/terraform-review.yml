# This file is managed by Terraform in github-control repository
# Do not edit this file, all changes will be overwritten
# If you need to change this file, create a pull request in
# https://github.com/infrahouse8/github-control
---
name: Terraform Module Review

on:  # yamllint disable-line rule:truthy
  pull_request:

concurrency:
  group: terraform-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for proper diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create reviews directory
        run: mkdir -p .claude/reviews .claude/previous-review

      - name: Download previous review from PR comment
        id: download_previous
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Find existing comment with review
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.body.includes('<!-- terraform-review-bot -->')
            );

            if (botComment) {
              // Extract review content (remove header and marker)
              const body = botComment.body;
              const reviewStart = body.indexOf('\n\n') + 2; // Skip "## ðŸ¤– Terraform Module Review\n\n"
              const reviewEnd = body.lastIndexOf('\n\n<!-- terraform-review-bot -->');
              const reviewContent = body.substring(reviewStart, reviewEnd);

              // Save to file
              fs.writeFileSync('.claude/previous-review/terraform-module-review.md', reviewContent);
              console.log('Previous review extracted from PR comment');
              return { has_previous: true };
            } else {
              console.log('No previous review found - this is the first review');
              return { has_previous: false };
            }

      - name: Check for previous review
        id: check_previous
        run: |
          if [ -f ".claude/previous-review/terraform-module-review.md" ]; then
            echo "has_previous=true" >> $GITHUB_OUTPUT
            echo "Previous review found"
          else
            echo "has_previous=false" >> $GITHUB_OUTPUT
            echo "No previous review found - this is the first review"
          fi

      - name: Get PR diff
        id: diff
        run: |
          # Get the diff between base and head
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr-changes.diff
          echo "Changes in this PR:"
          cat pr-changes.diff

      - name: Run Terraform Module Review (First Review)
        if: steps.check_previous.outputs.has_previous == 'false'
        run: |
          npx @anthropic-ai/claude-code --print --output-format json \
            --dangerously-skip-permissions \
            "Launch the terraform-module-reviewer agent. \
          Review all changes in pr-changes.diff file. \
          Focus your review on the changes made in this PR while \
          considering the overall module context. \
          Analyze what was added, modified, or removed, and assess \
          the impact on the module's security, functionality, and \
          best practices compliance. \
          IMPORTANT: Save your complete review to \
          .claude/reviews/terraform-module-review.md as specified in \
          your agent instructions." \
            > claude-output.json
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Run Terraform Module Review (Follow-up Review)
        if: steps.check_previous.outputs.has_previous == 'true'
        run: |
          npx @anthropic-ai/claude-code --print --output-format json \
            --dangerously-skip-permissions \
            "Launch the terraform-module-reviewer agent. \
          This is a follow-up review. \
          Read the previous review from \
          .claude/previous-review/terraform-module-review.md and the \
          current changes in pr-changes.diff. \
          Compare the previous findings with the current state:
            - Mark issues as 'âœ… FIXED:' if they have been resolved
            - Mark issues as 'âš ï¸ STILL PRESENT:' if unaddressed
            - Mark new issues as 'ðŸ†• NEW:' if they appear for the \
          first time
            - Provide a summary at the top showing progress \
          (e.g., '3 issues fixed, 1 still present, 2 new issues found')
            Focus on showing what has improved and what still needs \
          attention.
          IMPORTANT: Save your complete review to \
          .claude/reviews/terraform-module-review.md as specified in \
          your agent instructions." \
            > claude-output.json
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Check if review file exists
        id: check_review
        run: |
          if [ -f ".claude/reviews/terraform-module-review.md" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Review file created successfully"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Warning: Review file not found"
          fi

      - name: Upload Claude Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-output
          path: claude-output.json

      - name: Post Review as PR Comment
        if: steps.check_review.outputs.exists == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('.claude/reviews/terraform-module-review.md', 'utf8');

            // Truncate if too long for GitHub comment (65536 char limit)
            const maxLength = 65000;
            const content = reviewContent.length > maxLength
              ? reviewContent.substring(0, maxLength) + '\n\n... (truncated)'
              : reviewContent;

            const body = `## ðŸ¤– Terraform Module Review\n\n${content}\n\n<!-- terraform-review-bot -->`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.body.includes('<!-- terraform-review-bot -->')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new review comment');
            }
