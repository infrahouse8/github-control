# This file is managed by Terraform in github-control repository
# Do not edit this file, all changes will be overwritten
# If you need to change this file, create a pull request in
# https://github.com/tinyfish-io/github-control
---
name: OSV-Scanner PR Scan

on:  # yamllint disable-line rule:truthy
  pull_request:
    branches: [main]
  merge_group:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

env:
  GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

jobs:
  vulnerability-check:
    runs-on: ["self-hosted", "Linux"]
    steps:
      - uses: actions/checkout@v4
      - name: Detect vulnerabilities
        run: |
          if [ -n "${{ github.event.pull_request.number }}" ]; then
            ih-github scan \
            --repo ${{ github.repository }} \
            --pull-request ${{ github.event.pull_request.number }}
          else
            ih-github scan
          fi

  sast-check:
    runs-on: ["self-hosted", "Linux", "sast-eligible"]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: SAST
        run: |
          pip install --upgrade semgrep
          ih-github run \
          ${{ github.repository }} \
          ${{ github.event.pull_request.number }} \
          semgrep scan --error
