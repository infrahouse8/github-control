#!/usr/bin/env bash
# This file is managed by Terraform in github-control repository
# Do not edit this file, all changes will be overwritten
# If you need to change this file, create a pull request in
# https://github.com/infrahouse8/github-control

set -e

echo "üîç Running pre-commit checks..."

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "‚ùå Not in a git repository"
    exit 1
fi

# Get the root of the git repository
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# 1. Terraform formatting check
echo "üìù Checking Terraform formatting..."
if ! terraform fmt -check -recursive; then
    echo "‚ùå Terraform files need formatting"
    echo "   Run: terraform fmt -recursive"
    exit 1
fi
echo "‚úÖ Terraform formatting OK"

# 2. Update terraform-docs
if command -v terraform-docs &> /dev/null; then
    echo "üìö Updating terraform documentation..."

    # Run terraform-docs
    if terraform-docs . > /dev/null 2>&1; then
        # Check if README.md changed
        if git diff --quiet README.md; then
            echo "‚úÖ Documentation up to date"
        else
            echo "üìù README.md updated with terraform-docs"
            git add README.md
            echo "‚úÖ Documentation changes staged"
        fi
    else
        echo "‚ùå Failed to generate terraform-docs"
        exit 1
    fi
else
    echo "‚ö†Ô∏è  terraform-docs not installed"
    echo "   Install it: https://terraform-docs.io/user-guide/installation/"
    echo "   Or: brew install terraform-docs"
    echo ""
    echo "‚ö†Ô∏è  Skipping documentation check"
fi

echo ""
echo "‚ú® All pre-commit checks passed!"
echo "Happy coding!"