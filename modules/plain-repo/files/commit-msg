#!/usr/bin/env bash
# This file is managed by Terraform in github-control repository
# Do not edit this file, all changes will be overwritten
# If you need to change this file, create a pull request in
# https://github.com/infrahouse8/github-control

# Validates commit messages follow conventional commit format
# See: https://www.conventionalcommits.org/

set -e

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Skip validation for merge commits
if echo "$commit_msg" | grep -qE '^Merge (branch|pull request)'; then
    exit 0
fi

# Conventional commit pattern
# Supports: type(scope): description or type: description
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, security
# Optional ! for breaking changes: feat!: description
pattern='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|security)(\(.+\))?!?: .{1,}'

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo "âŒ Invalid commit message format"
    echo ""
    echo "ğŸ“ Commit message must follow Conventional Commits:"
    echo ""
    echo "  <type>[optional scope][!]: <description>"
    echo ""
    echo "  [optional body]"
    echo ""
    echo "  [optional footer(s)]"
    echo ""
    echo "Types:"
    echo "  feat:     âœ¨ New feature"
    echo "  fix:      ğŸ› Bug fix"
    echo "  docs:     ğŸ“š Documentation changes"
    echo "  security: ğŸ”’ Security improvements"
    echo "  refactor: â™»ï¸  Code refactoring (no functional changes)"
    echo "  perf:     âš¡ Performance improvement"
    echo "  test:     âœ… Adding or updating tests"
    echo "  build:    ğŸ”§ Build system or dependency changes"
    echo "  ci:       ğŸ‘· CI/CD configuration changes"
    echo "  chore:    ğŸ”¨ Maintenance tasks"
    echo "  revert:   âª Revert a previous commit"
    echo "  style:    ğŸ’„ Code style changes (formatting, etc.)"
    echo ""
    echo "Breaking changes:"
    echo "  Use ! after type: feat!: breaking change description"
    echo ""
    echo "Examples:"
    echo "  âœ“ feat: add deregistration delay configuration"
    echo "  âœ“ fix: correct unhealthy threshold variable name"
    echo "  âœ“ security: add S3 bucket encryption for access logs"
    echo "  âœ“ docs: improve variable descriptions using HEREDOC"
    echo "  âœ“ feat(alb): add listener rule priority documentation"
    echo "  âœ“ feat!: remove deprecated variables (breaking change)"
    echo ""
    echo "Your message:"
    echo "  $commit_msg"
    echo ""
    echo "See: https://www.conventionalcommits.org/"
    exit 1
fi

# Success - message is valid
exit 0